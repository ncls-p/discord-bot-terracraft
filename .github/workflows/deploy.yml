name: Deploy

on:
    push:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Execute remote commands
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  port: ${{ secrets.PORT }}
                  key: ${{ secrets.SSHKEY }}
                  script: |
                      # Clone or update repository
                      if [ ! -d "/home/blury/bot/discord/discord-bot-terracraft" ]; then
                        git clone git@github.com:ncls-p/discord-bot-terracraft.git /home/blury/bot/discord/discord-bot-terracraft
                      else
                        cd /home/blury/bot/discord/discord-bot-terracraft && git pull
                      fi

                      # Build Docker image
                      cd /home/blury/bot/discord/discord-bot-terracraft
                      docker build -f docker/Dockerfile -t discord-bot-terracraft .

                      # Start Docker container
                      docker-compose down
                      docker-compose up -d
